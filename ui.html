<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCubee Video Search System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --dark-bg: #0a0e1a;
            --card-bg: rgba(20, 25, 40, 0.85);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --accent-blue: #4facfe;
            --accent-purple: #667eea;
            --accent-pink: #f093fb;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { background: var(--dark-bg); background-image: radial-gradient(circle at 25% 25%, rgba(102, 126, 234, 0.1) 0%, transparent 50%), radial-gradient(circle at 75% 75%, rgba(240, 147, 251, 0.1) 0%, transparent 50%); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .top-toolbar { position: fixed; top: 0; left: 0; width: 100%; background: rgba(10, 14, 26, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 12px 32px; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: var(--shadow-light); height: 80px; }
        .toolbar-left, .toolbar-right { display: flex; gap: 24px; align-items: center; }
        .app-title { font-size: 1.8rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; display: flex; align-items: center; gap: 12px; text-shadow: 0 0 30px rgba(102, 126, 234, 0.5); }
        .app-logo { height: 65px; width: 65px; border-radius: 0%; object-fit: cover; }
        .model-btn-wrapper { position: relative; }
        .toolbar-btn { background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 12px 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 10px; font-size: 0.95rem; font-weight: 500; position: relative; overflow: hidden; }
        .toolbar-btn .btn-hover-bg { position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: var(--primary-gradient); transition: left 0.3s ease; z-index: 0; }
        .toolbar-btn > span { position: relative; z-index: 1; display: flex; align-items: center; gap: 10px; }
        .toolbar-btn:hover .btn-hover-bg { left: 0; }
        .toolbar-btn:hover { transform: translateY(-2px); border-color: var(--accent-blue); box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3); color: var(--text-primary); }
        .toolbar-btn.active { background: var(--success-gradient); border-color: var(--accent-blue); color: var(--text-primary); font-weight: 600; box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4); }
        .model-dropdown { display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: var(--card-bg); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow-heavy); padding: 12px; z-index: 101; width: 220px; }
        .main-content-wrapper { display: flex; flex-grow: 1; padding-top: 80px; height: 100vh; gap: 2px; }
        #left-search-panel { width: 380px; flex-shrink: 0; background: var(--card-bg); backdrop-filter: blur(20px); border-right: 1px solid var(--border-color); padding: 24px; display: flex; flex-direction: column; box-shadow: var(--shadow-light); }
        #right-results-panel { flex-grow: 1; overflow-y: auto; background: rgba(10, 14, 26, 0.3); }
        .stages-container { display: flex; flex-direction: column; gap: 24px; padding-top: 24px; overflow-y: auto; padding-right: 12px; flex-grow: 1; }
        .stage-card { background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 16px; padding: 24px; position: relative; border: 1px solid var(--border-color); box-shadow: var(--shadow-light); flex-shrink: 0; transition: all 0.3s ease; }
        .stage-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-heavy); border-color: var(--accent-blue); }
        .stage-number { position: absolute; top: -14px; left: 0px; background: var(--primary-gradient); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); z-index: 1;}
        .stage-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .query-types {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap; /* Ngăn không cho các nút xuống hàng */
            flex-grow: 1;     /* Yêu cầu nó chiếm hết không gian trống còn lại */
        }
        .type-btn { width: 44px; height: 44px; font-size: 1.1rem; background: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); position: relative; overflow: hidden; }
        .type-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: var(--primary-gradient); border-radius: 50%; transition: all 0.3s ease; transform: translate(-50%, -50%); z-index: -1; }
        .type-btn.active::before { width: 200%; height: 200%; }
        .type-btn.active { background: transparent; border-color: var(--accent-blue); color: var(--text-primary); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3); }
        .type-btn[data-type="asr"].active, .type-btn[data-type="ocr"].active, .type-btn[data-type="gen_image"].active { border-color: var(--accent-pink); box-shadow: 0 8px 20px rgba(240, 147, 251, 0.3); }
        .type-btn[data-type="asr"].active::before, .type-btn[data-type="ocr"].active::before, .type-btn[data-type="gen_image"].active::before { background: var(--secondary-gradient); }
        .type-btn:hover:not(.active) { border-color: var(--accent-purple); color: var(--accent-purple); transform: translateY(-2px); }
        .delete-stage {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(244, 63, 94, 0.1);
            border: 1px solid rgba(244, 63, 94, 0.3);
            color: #f43f5e;
            width: 16px; /* Có thể giảm kích thước một chút cho gọn */
            height: 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10; /* Đảm bảo nó nằm trên các phần tử khác */
        }
        .delete-stage:hover { background: rgba(244, 63, 94, 0.2); transform: scale(1.1) rotate(5deg); box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3); }
        .stage-options { display: flex; gap: 12px; margin-top: 20px; }
        .option-btn { background: var(--glass-bg); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 16px; border-radius: 10px; font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .option-btn.active { background: var(--success-gradient); border-color: var(--accent-blue); color: var(--text-primary); font-weight: 600; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3); }
        .option-btn:hover:not(.active) { border-color: var(--accent-blue); color: var(--accent-blue); transform: translateY(-1px); }
        .panel-controls { display: flex; justify-content: space-between; align-items: center; margin-top: auto; flex-shrink: 0; padding-top: 24px; border-top: 1px solid var(--border-color); }
        .stage-controls { display: flex; gap: 16px; }
        .control-btn { width: 54px; height: 54px; border-radius: 14px; border: 1px solid var(--border-color); background: var(--glass-bg); color: var(--text-secondary); font-size: 1.4rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .control-btn:hover { background: var(--primary-gradient); transform: scale(1.05) translateY(-2px); color: var(--text-primary); border-color: var(--accent-blue); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .search-btn { background: var(--primary-gradient); color: white; border: none; padding: 16px 32px; border-radius: 14px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 12px; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); position: relative; overflow: hidden; }
        .search-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .search-btn:hover::before { left: 100%; }
        .search-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6); }
        .query-input-area { margin-top: 15px; position: relative; }
        .stage-input { width: 100%; padding: 12px 16px; background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 1.0rem; line-height: 1.5; resize: vertical; transition: all 0.3s ease; font-family: inherit; }
        .main-query-input { min-height: 80px; }
        .stage-input:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2); background: rgba(79, 172, 254, 0.05); }
        .stage-input-file { display: none; }
        .image-upload-zone { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 160px; border: 2px dashed var(--border-color); border-radius: 12px; background: var(--glass-bg); color: var(--text-secondary); cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; backdrop-filter: blur(10px); }
        .image-upload-zone.dragover { border-color: var(--accent-blue); background: rgba(79, 172, 254, 0.1); transform: scale(1.02); }
        .image-upload-zone:hover { border-color: var(--accent-purple); background: rgba(102, 126, 234, 0.05); }
        .image-upload-zone i { font-size: 2.5rem; margin-bottom: 10px; }
        .image-upload-zone p { font-size: 0.9rem; text-align: center; }
        .image-preview { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .remove-image-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.3); color: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; z-index: 2; }
        .remove-image-btn:hover { background: #ef4444; color: white; border-color: transparent; }
        .model-dropdown-item { display: flex; align-items: center; padding: 12px 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .model-dropdown-item:hover { background: var(--glass-bg); }
        .model-dropdown-item.focused { background: var(--glass-bg); outline: 2px solid var(--accent-blue); outline-offset: -2px; }
        .model-dropdown-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--accent-blue); }
        .model-dropdown-item label { cursor: pointer; user-select: none; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .result-item { background: var(--card-bg); backdrop-filter: blur(15px); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); aspect-ratio: 16 / 9; cursor: pointer; position: relative; }
        .result-item:hover { transform: scale(1.03) translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); border-color: var(--accent-blue); }
        /* ## LAZY LOADING STYLES ## */
        .result-item img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.3s ease, opacity 0.4s ease-in-out; opacity: 0; }
        .result-item img.loaded { opacity: 1; }
        /* ######################## */
        .result-item:hover img { transform: scale(1.05); }
        .submit-btn { position: absolute; top: 8px; right: 8px; background: rgba(79, 172, 254, 0.8); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: none; align-items: center; justify-content: center; z-index: 5; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); backdrop-filter: blur(25px); border: 1px solid var(--border-color); width: 90%; max-width: 1200px; max-height: 90vh; border-radius: 20px; box-shadow: var(--shadow-heavy); display: flex; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.5rem; color: var(--accent-blue); }
        .modal-close { font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; }
        .modal-close:hover { color: #ef4444; }
        .modal-body { padding: 25px; display: flex; gap: 30px; overflow-y: auto; }
        .modal-body .filter-input { background: rgba(10, 14, 26, 0.8); border: 1px solid var(--border-color); color: white; border-radius: 6px; padding: 8px 10px; font-size: 0.95rem; width: 100%; }
        .modal-body .filter-input:focus { outline: none; border-color: var(--accent-blue); }
        .dres-status { margin-top: 15px; font-size: 0.9rem; color: var(--text-secondary); text-align: center; width: 100%; }
        .filter-section { flex: 1; display: flex; flex-direction: column; }
        .filter-section-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .filter-section-title { font-size: 1.2rem; color: var(--accent-blue); }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--accent-blue); }
        input:checked + .slider:before { transform: translateX(22px); }
        .filter-controls-container { display: flex; flex-direction: column; gap: 15px; }
        .count-filter-row { display: grid; grid-template-columns: 30px 1fr 120px; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 8px; border: 1px solid transparent; transition: background-color 0.2s, border-color 0.2s; }
        .count-filter-row:hover { background-color: rgba(79, 172, 254, 0.1); }
        .count-filter-row.active-row { background-color: rgba(79, 172, 254, 0.15); border-color: rgba(79, 172, 254, 0.4); }
        .count-filter-row.custom { grid-template-columns: 30px 1fr 120px 30px; }
        .count-filter-row input[type=checkbox] { accent-color: var(--accent-blue); width: 18px; height: 18px; cursor: pointer; }
        .count-filter-row label { font-size: 1rem; color: var(--text-primary); }
        .add-custom-btn, .remove-custom-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary); width: 30px; height: 30px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .add-custom-btn:hover, .remove-custom-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        #positioningCanvas { background: #1e293b; border-radius: 10px; cursor: crosshair; touch-action: none; }
        .drawn-boxes-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .drawn-box-item { display: flex; align-items: center; justify-content: space-between; background: #1e293b; padding: 8px; border-radius: 6px; }
        .drawn-box-item.active { border-left: 3px solid var(--accent-blue); }
        .shortcuts-info { font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px; line-height: 1.6; }
        .image-modal-overlay { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.95); backdrop-filter: blur(20px); align-items: center; justify-content: center; }
        .image-modal-content { margin: auto; display: block; max-width: 90vw; max-height: 90vh; animation: modalZoom 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 12px; box-shadow: var(--shadow-heavy); }
        @keyframes modalZoom { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .image-modal-close { position: absolute; top: 20px; right: 40px; color: var(--text-primary); font-size: 24px; font-weight: bold; transition: all 0.3s ease; cursor: pointer; z-index: 2101; background: rgba(0, 0, 0, 0.5); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .image-modal-close:hover { color: var(--accent-pink); transform: scale(1.1) rotate(90deg); background: rgba(244, 63, 94, 0.2); }
        #temporalContextModal, #dresModal { z-index: 2000; }
        #imageModal, #videoPreviewModal { z-index: 2100; }
        #temporalContextModal .temporal-modal-content { background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 16px; width: 95%; max-width: 1600px; height: auto; max-height: 95vh; display: flex; flex-direction: column; box-shadow: var(--shadow-heavy); animation: modalZoom 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #temporalContextModal .temporal-modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #temporalContextModal #temporalModalTitle { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        #temporalContextModal .image-modal-close { position: static; width: 36px; height: 36px; font-size: 1.2rem; }
        #temporalContextModal .temporal-modal-body { padding: 24px; overflow-y: auto; flex-grow: 1; }
        .temporal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
        .temporal-grid-item { position: relative; background-color: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; aspect-ratio: 16 / 9; cursor: pointer; transition: all 0.2s ease-in-out; }
        .temporal-grid-item:hover { transform: scale(1.05); border-color: var(--accent-blue); z-index: 10; }
        .temporal-grid-item.center-frame { border: 2px solid var(--accent-purple); box-shadow: 0 0 15px rgba(102, 126, 234, 0.6); }
        .temporal-grid-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .temporal-item-label { position: absolute; top: 4px; left: 4px; background-color: rgba(0, 0, 0, 0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        #temporalContextModal .temporal-modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); text-align: center; font-size: 0.9rem; color: var(--text-secondary); flex-shrink: 0; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--primary-gradient); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--secondary-gradient); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #loadingIndicator { animation: pulse 2s infinite; color: var(--accent-blue); font-size: 1.4rem; padding: 40px 24px; }
        #loadingIndicator i { margin-right: 10px; }
        .processed-query-display-wrapper { display: none; margin-top: 10px; padding: 8px 12px; background: rgba(0,0,0,0.25); border-radius: 8px; border-left: 3px solid var(--accent-purple); align-items: center; gap: 10px; transition: all 0.3s ease; }
        .processed-query-display-wrapper i { color: var(--accent-purple); }
        .processed-query-display { font-size: 0.9rem; color: var(--text-secondary); font-style: italic; word-break: break-all; }
        .timing-info-container { display: none; flex-wrap: wrap; gap: 12px 20px; padding: 16px; background: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 12px; backdrop-filter: blur(10px); margin: 24px; }
        .timing-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .timing-item .timing-label { color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .timing-item .timing-value { font-weight: 600; color: var(--text-primary); background-color: rgba(255, 255, 255, 0.1); padding: 3px 8px; border-radius: 6px; }
        .timing-item.total-time .timing-value { font-weight: 700; font-size: 1rem; }
        .timing-item.client-time .timing-value { background-color: rgba(240, 147, 251, 0.15); color: var(--accent-pink); }
        .timing-item.server-time .timing-value { background-color: rgba(79, 172, 254, 0.15); color: var(--accent-blue); }
        .cluster-separator { border: 0; height: 1px; background-image: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0)); margin: 40px 0; }
        .cluster-header { color: var(--accent-purple); font-size: 1.1rem; margin-bottom: 12px; padding-left: 8px; border-left: 3px solid var(--accent-purple); }
        .temporal-stage-grid-container { margin-top: 30px; padding-top: 30px; border-top: 1px solid var(--border-color); }
        .temporal-stage-grid-container:first-of-type { margin-top: 0; padding-top: 0; border-top: none; }
        #usernameModal { z-index: 3000; }
        #resultsContainer { padding: 0 24px 24px 24px; }

        /* ## START: Teamwork Panel CSS Changes ## */
        #teamworkPanelContainer {
            padding-top: 24px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0; /* ## FIX: Stick flush to the top ## */
            background: rgba(10, 14, 26, 0.85);
            backdrop-filter: blur(15px);
            z-index: 50;
        }
        #teamworkPanelContainer h3 {
            font-size: 1.3rem;
            color: var(--accent-purple);
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 0 24px;
        }
        #teamworkGrid {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 16px;
            padding: 0 24px 24px 24px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #teamworkGrid::-webkit-scrollbar { display: none; }
        #teamworkGrid .result-item {
            flex: 0 0 220px;
        }
        .teamwork-item {
            border: 3px solid var(--user-color, var(--accent-blue));
            box-shadow: 0 0 15px 0px var(--user-color, var(--accent-blue));
        }
        .teamwork-item-user-label {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            border-left: 3px solid var(--user-color, var(--accent-blue));
        }

        /* ## START: CSS FIX FOR BLUE CIRCLE ## */
        .temporal-grid-item:hover .submit-btn,
        .teamwork-item:hover .submit-btn {
            display: flex;
        }
        /* ## END: CSS FIX FOR BLUE CIRCLE ## */

        .submit-btn:hover {
            background: var(--accent-blue);
            transform: scale(1.1);
        }
        /* ## END: Teamwork Panel CSS Changes ## */

        #google-image-search-container {
            padding-bottom: 24px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .google-search-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        .google-search-header .fa-google {
            color: var(--accent-blue);
        }
        .google-search-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        #googleSearchInput {
            flex-grow: 1;
        }
        #googleSearchBtn {
            width: auto;
            height: 48px;
            padding: 0 16px;
        }
        #google-image-results-wrapper {
            margin-top: 16px;
        }
        #google-image-results {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            min-height: 120px;
            align-items: center;
        }
        .google-image-item {
            flex: 0 0 160px;
            height: 90px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        .google-image-item:hover {
            border-color: var(--accent-blue);
        }
        .google-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .google-image-item .overlay-actions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .google-image-item:hover .overlay-actions {
            opacity: 1;
        }
        .google-image-item .overlay-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .google-image-item .overlay-btn:hover {
            background: var(--accent-blue);
            transform: scale(1.1);
        }
    /* ## START: NEW CSS FOR VIDEO PREVIEW ENHANCEMENTS ## */
        .video-player-container {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* ## END: NEW CSS FOR VIDEO PREVIEW ENHANCEMENTS ## */
    </style>
</head>
<body>
    <div class="top-toolbar">
        <div class="toolbar-left">
            <div class="app-title">
                <img src="/static/logo.png" alt="OpenCubee Logo" class="app-logo">
                <span>OpenCubee</span>
            </div>
            <div id="userInfo" style="color: var(--text-secondary);"></div>
        </div>
        <div class="toolbar-right">
            <button class="toolbar-btn" id="dresBtn" title="DRES Submission"><div class="btn-hover-bg"></div><span><i class="fas fa-trophy"></i> DRES</span></button>
            <div class="model-btn-wrapper">
                <button id="modelSelectBtn" class="toolbar-btn" title="Toggle Models (Ctrl+M)"><div class="btn-hover-bg"></div><span><i class="fas fa-layer-group"></i> Models</span></button>
                <div id="modelDropdown" class="model-dropdown">
                    <div class="model-dropdown-item"><input type="checkbox" id="model-beit3" value="beit3" checked><label for="model-beit3">BEiT-3</label></div>
                    <div class="model-dropdown-item"><input type="checkbox" id="model-bge" value="bge" checked><label for="model-bge">BGE-VL</label></div>
                    <div class="model-dropdown-item"><input type="checkbox" id="model-unite" value="unite" checked><label for="model-unite">Unite</label></div>
                    <div class="model-dropdown-item"><input type="checkbox" id="model-ops_mm" value="ops_mm" checked><label for="model-ops_mm">Ops-MM</label></div>
                </div>
            </div>
            <button class="toolbar-btn" id="objectFilterBtn" title="Object Filters (Ctrl+F)"><div class="btn-hover-bg"></div><span><i class="fas fa-shapes"></i> Filters</span></button>
            <button class="toolbar-btn" id="clusterBtn" title="Toggle Clustering (Ctrl+G)"><div class="btn-hover-bg"></div><span><i class="fas fa-object-group"></i> Cluster</span></button>
            <button class="toolbar-btn" id="ambiguousBtn" title="Toggle Ambiguous Temporal Search (Ctrl+Shift+G)"><div class="btn-hover-bg"></div><span><i class="fas fa-random"></i> Ambiguous</span></button>
            <button class="toolbar-btn" id="resetBtn" title="Reset Search (Ctrl+Shift+R)"><div class="btn-hover-bg"></div><span><i class="fas fa-redo"></i> Reset Search</span></button>
        </div>
    </div>
    <div class="main-content-wrapper">
        <div id="left-search-panel">
            <div id="google-image-search-container">
                <div class="google-search-header">
                </div>
                <div class="google-search-input-wrapper">
                    <input type="text" id="googleSearchInput" class="stage-input" placeholder="Tìm ảnh trên Google...">
                    <button id="googleSearchBtn" class="control-btn" title="Search"><i class="fas fa-search"></i></button>
                </div>
                <div id="google-image-results-wrapper" style="display: none;">
                    <div id="google-image-results">
                        <!-- Fetched images will appear here -->
                    </div>
                </div>
            </div>
            <div class="stages-container" id="stagesContainer"></div>
            <div class="panel-controls">
                <div class="stage-controls">
                    <button class="control-btn" id="addStageBtn" title="Add Stage to End (Ctrl+])"><i class="fas fa-plus"></i></button>
                    <button class="control-btn" id="removeStageBtn" title="Remove Last Stage (Ctrl+Shift+])"><i class="fas fa-minus"></i></button>
                </div>
                <button class="search-btn" id="searchBtn" title="Search (Enter)"><i class="fas fa-search"></i> Search</button>
            </div>
        </div>
        <div id="right-results-panel">
            <div id="teamworkPanelContainer" style="display: none;">
                <h3><i class="fas fa-users"></i> Teamwork Submission Panel</h3>
                <div id="teamworkGrid"></div>
            </div>
            <div id="timingInfoDisplay" class="timing-info-container"></div>
            <div id="loadingIndicator" style="display: none; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Performing Search...</div>
            <div id="resultsContainer">
                <p style="text-align: center; color: var(--text-secondary); padding-top: 100px; font-size: 1.2rem;">Sử dụng bảng điều khiển bên trái để bắt đầu tìm kiếm.</p>
            </div>
        </div>
    </div>

    <div id="usernameModal" class="modal-overlay" style="display: flex; z-index: 3000;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title" style="width: 100%; text-align: center; color: var(--text-primary); font-weight: 600;">Welcome to OpenCubee!</h2>
            </div>
            <div class="modal-body" style="flex-direction: column; gap: 20px;">
                <p style="color: var(--text-secondary);">Please enter your name to join the session.</p>
                <input type="text" id="usernameInput" class="filter-input" placeholder="Your Name...">
                <button id="usernameSubmitBtn" class="search-btn" style="width: 100%;">Join</button>
            </div>
        </div>
    </div>

    <div id="objectFilterModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 class="modal-title"><i class="fas fa-shapes"></i> Object Filters</h2><span class="modal-close" id="modalCloseBtn">&times;</span></div><div class="modal-body"><div class="filter-section"><div class="filter-section-header"><h3 class="filter-section-title">Object Counting</h3><label class="switch"><input type="checkbox" id="enableCountFilter"><span class="slider"></span></label></div><div id="countFilterControls" class="filter-controls-container"></div><button class="add-custom-btn" id="addCustomCountBtn" style="margin-top: 15px; width: 100%;"><i class="fas fa-plus"></i> Add Custom Object</button></div><div class="filter-section"><div class="filter-section-header"><h3 class="filter-section-title">Object Positioning</h3><label class="switch"><input type="checkbox" id="enablePositionFilter"><span class="slider"></span></label></div><div class="position-controls"><canvas id="positioningCanvas" width="640" height="360"></canvas><div id="drawnBoxesList" class="drawn-boxes-list"></div><p class="shortcuts-info"><b>Shortcuts:</b> Draw box with mouse. <br><b>1-6:</b> person, car, truck, dog, cat, toaster. <b>7:</b> Custom. <br><b>Backspace:</b> Delete last box. <b>C:</b> Clear all.</p></div></div></div></div></div>
    <div id="imageModal" class="image-modal-overlay"><span class="image-modal-close" title="Close (Esc)">&times;</span><img class="image-modal-content" id="zoomedImage"></div>
    <div id="temporalContextModal" class="image-modal-overlay"><div class="temporal-modal-content"><div class="temporal-modal-header"><h2 id="temporalModalTitle"></h2><span class="image-modal-close" id="closeTemporalModalBtn" title="Close (Esc)">&times;</span></div><div class="temporal-modal-body"><div class="temporal-grid" id="temporalGrid"></div></div><div class="temporal-modal-footer">Shortcuts: Click to zoom. Ctrl+Click/Space on button to Push. Ctrl+Shift+Click/Space on button to Submit Direct.</div></div></div>
    
    <!-- ## START: MODIFIED DRES MODAL WITH NEW FLOW ## -->
    <div id="dresModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-trophy"></i> DRES Submission</h2>
                <span class="modal-close" id="dresModalCloseBtn">&times;</span>
            </div>
            <div class="modal-body" style="flex-direction: column; gap: 20px;">
                
                <!-- View 1: Initial Login Button -->
                <div id="dresInitialView">
                    <button id="dresShowLoginBtn" class="search-btn" style="width: 100%;">Login to DRES</button>
                </div>
                
                <!-- View 2: Login Form (hidden by default) -->
                <div id="dresLoginView" style="display: none; flex-direction: column; gap: 20px;">
                    <div>
                        <label for="dresUsername">Username</label>
                        <input type="text" id="dresUsername" class="filter-input" placeholder="Enter your username...">
                    </div>
                    <div>
                        <label for="dresPassword">Password</label>
                        <input type="password" id="dresPassword" class="filter-input" placeholder="Enter your password...">
                    </div>
                    <button id="dresLoginBtn" class="search-btn" style="width: 100%;">Login & Get Evaluations</button>
                </div>
                
                <!-- View 3: Evaluation Selector (hidden by default) -->
                <div id="dresEvaluationView" style="display: none; width: 100%;">
                    <label for="dresEvaluationSelect">Select Evaluation</label>
                    <select id="dresEvaluationSelect" class="filter-input" disabled></select>
                </div>

                <!-- Status message is always visible -->
                <div id="dresStatus" class="dres-status">Status: Not logged in.</div>
            </div>
        </div>
    </div>
    <!-- ## END: MODIFIED DRES MODAL ## -->

    <!-- ## START: MODIFIED VIDEO PREVIEW MODAL ## -->
    <div id="videoPreviewModal" class="image-modal-overlay">
        <span class="image-modal-close" id="closeVideoModalBtn" title="Close (Esc)">&times;</span>
        <div class="video-player-container">
            <video id="videoPlayer" class="image-modal-content" controls autoplay style="background-color: #000;"></video>
            
            <!-- Container for the action buttons -->
            <div id="videoActionButtons" style="margin-top: 20px; display: flex; gap: 15px;">
                <button id="pushCurrentFrameBtn" class="toolbar-btn" style="width: auto; padding: 12px 24px; font-size: 1rem;" title="Push to Team (Ctrl+Space in player)">
                    <div class="btn-hover-bg"></div>
                    <span><i class="fas fa-users"></i> Push to Team</span>
                </button>
                <button id="submitCurrentFrameBtn" class="search-btn" style="width: auto; padding: 12px 24px; font-size: 1rem;" title="Submit to DRES (Ctrl+Shift+Space in player)">
                    <i class="fas fa-paper-plane"></i> Submit Frame
                </button>
            </div>
        </div>
    </div>
    <!-- ## END: MODIFIED VIDEO PREVIEW MODAL ## -->

    <script>
        // ## MERGED & CORRECTED SCRIPT ##
        let ws;
        let username = '';
        let userColor = '';
        let currentlyHoveredItemData = null;
        let currentlyHoveredItemElement = null;
        let lastSuccessfulSubmission = null;
        let pushedFrames = new Set();
        let currentPage = 1;
        let totalResults = 0;
        let isLoadingMore = false;
        let lastSearchPayload = null;
        let currentVideoPreviewData = null; // <<< ADD THIS LINE

        const PAGE_SIZE = 30;

        // ## LAZY LOADING ##
        let imageObserver = null;
        // ##################

        function displayTimingInfo(serverTimings, clientStartTime) { const container = document.getElementById('timingInfoDisplay'); const clientTotalTime = (performance.now() - clientStartTime) / 1000; if ((!serverTimings || Object.keys(serverTimings).length === 0) && !clientTotalTime) { container.style.display = 'none'; return; } container.innerHTML = ''; const createTimingItem = (label, value, icon, extraClass = '') => { if (typeof value !== 'number') return ''; return `<div class="timing-item ${extraClass}"><span class="timing-label"><i class="${icon}"></i> ${label}:</span><span class="timing-value">${value.toFixed(3)} s</span></div>`; }; container.innerHTML += createTimingItem('Total User Time', clientTotalTime, 'fas fa-desktop', 'total-time client-time'); if (serverTimings && serverTimings.total_request_s) { container.innerHTML += createTimingItem('Total Server Time', serverTimings.total_request_s, 'fas fa-server', 'total-time server-time'); } if (serverTimings) { const timingLabels = {'query_processing_s': { label: 'Query Prep', icon: 'fas fa-cogs' }, 'ocr_asr_filtering_s': { label: 'Text Filter', icon: 'fas fa-filter' }, 'embedding_generation_s': { label: 'Embedding', icon: 'fas fa-brain' }, 'vector_search_s': { label: 'Vector Search', icon: 'fas fa-search-plus' }, 'post_processing_s': { label: 'Post-Process', icon: 'fas fa-sitemap' }, 'object_filter_precomputation_s': {label: 'Object Filter', icon: 'fas fa-th-large'}, 'stage_candidate_gathering_s': { label: 'Stage Search', icon: 'fas fa-tasks' }, 'sequence_assembly_s': { label: 'Sequence Assembly', icon: 'fas fa-link' }, 'final_processing_s': { label: 'Final Process', icon: 'fas fa-check-double' }}; const detailedKeys = Object.keys(serverTimings).filter(key => key !== 'total_request_s'); for (const key of detailedKeys) { if (timingLabels[key] && serverTimings[key] > 0) { const info = timingLabels[key]; container.innerHTML += createTimingItem(info.label, serverTimings[key], info.icon); } } } container.style.display = 'flex'; }
        function urlSafeB64Encode(str) { try { const utf8Bytes = new TextEncoder().encode(str); let binaryString = ''; utf8Bytes.forEach(byte => { binaryString += String.fromCharCode(byte); }); return btoa(binaryString).replace(/\+/g, '-').replace(/\//g, '_'); } catch (e) { console.error("Failed to encode string:", str, e); return ""; } }

        document.addEventListener('DOMContentLoaded', () => {
            const stagesContainer = document.getElementById('stagesContainer'); const addStageBtn = document.getElementById('addStageBtn'); const removeStageBtn = document.getElementById('removeStageBtn'); const searchBtn = document.getElementById('searchBtn'); const resultsContainer = document.getElementById('resultsContainer'); const loadingIndicator = document.getElementById('loadingIndicator'); const modelSelectBtn = document.getElementById('modelSelectBtn'); const modelDropdown = document.getElementById('modelDropdown'); const clusterBtn = document.getElementById('clusterBtn'); const ambiguousBtn = document.getElementById('ambiguousBtn'); const objectFilterBtn = document.getElementById('objectFilterBtn'); const objectFilterModal = document.getElementById('objectFilterModal'); const modalCloseBtn = document.getElementById('modalCloseBtn'); const imageModal = document.getElementById('imageModal'); const zoomedImage = document.getElementById('zoomedImage'); const closeImageModalBtn = document.querySelector('#imageModal .image-modal-close'); const temporalContextModal = document.getElementById('temporalContextModal'); const temporalGrid = document.getElementById('temporalGrid'); const temporalModalTitle = document.getElementById('temporalModalTitle'); const closeTemporalModalBtn = document.getElementById('closeTemporalModalBtn'); const enableCountFilter = document.getElementById('enableCountFilter'); const enablePositionFilter = document.getElementById('enablePositionFilter'); const countFilterControls = document.getElementById('countFilterControls'); const addCustomCountBtn = document.getElementById('addCustomCountBtn'); const posCanvas = document.getElementById('positioningCanvas'); const drawnBoxesList = document.getElementById('drawnBoxesList'); const posCtx = posCanvas.getContext('2d');
            
            // ## START: DRES MODAL ELEMENTS (NEW STRUCTURE) ##
            const dresBtn = document.getElementById('dresBtn'); // Toolbar button
            const dresModal = document.getElementById('dresModal');
            const dresModalCloseBtn = document.getElementById('dresModalCloseBtn');
            const dresInitialView = document.getElementById('dresInitialView');
            const dresShowLoginBtn = document.getElementById('dresShowLoginBtn');
            const dresLoginView = document.getElementById('dresLoginView');
            const dresUsername = document.getElementById('dresUsername');
            const dresPassword = document.getElementById('dresPassword');
            const dresLoginBtn = document.getElementById('dresLoginBtn'); // Form button
            const dresEvaluationView = document.getElementById('dresEvaluationView');
            const dresEvaluationSelect = document.getElementById('dresEvaluationSelect');
            const dresStatus = document.getElementById('dresStatus');
            // ## END: DRES MODAL ELEMENTS ##

            const googleSearchInput = document.getElementById('googleSearchInput');
            const googleSearchBtn = document.getElementById('googleSearchBtn');
            const googleResultsWrapper = document.getElementById('google-image-results-wrapper');
            const googleResultsContainer = document.getElementById('google-image-results');
            const rightResultsPanel = document.getElementById('right-results-panel');
            const videoPreviewModal = document.getElementById('videoPreviewModal');
            const videoPlayer = document.getElementById('videoPlayer');
            const closeVideoModalBtn = document.getElementById('closeVideoModalBtn');
            const submitCurrentFrameBtn = document.getElementById('submitCurrentFrameBtn');
            const pushCurrentFrameBtn = document.getElementById('pushCurrentFrameBtn');

            
            const usernameModal = document.getElementById('usernameModal'); const usernameInput = document.getElementById('usernameInput'); const usernameSubmitBtn = document.getElementById('usernameSubmitBtn'); const userInfoDisplay = document.getElementById('userInfo'); const teamworkPanelContainer = document.getElementById('teamworkPanelContainer'); const teamworkGrid = document.getElementById('teamworkGrid');
            let dresSessionId = sessionStorage.getItem('dresSessionId'); let dresEvaluationId = sessionStorage.getItem('dresEvaluationId'); let currentResponse = {}; let drawnBoxes = []; let isDrawing = false; let startX, startY, currentX, currentY; const PREDEFINED_OBJECTS = ['person', 'car', 'truck', 'dog', 'cat', 'cow', 'toaster']; const LABEL_SHORTCUTS = { '1': 'person', '2': 'car', '3': 'truck', '4': 'dog', '5': 'cat', '6': 'toaster'}; let focusedModelIndex = -1;

            // ## LAZY LOADING ##
            function setupImageObserver() {
                if (imageObserver) {
                    imageObserver.disconnect();
                }
                const options = {
                    root: rightResultsPanel, // Observe within the results panel
                    rootMargin: '0px 0px 500px 0px', // Start loading images 500px before they enter the viewport
                    threshold: 0.01
                };
                imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target.querySelector('img.lazy-load');
                            if (img && img.dataset.src) {
                                img.src = img.dataset.src;
                                img.onload = () => img.classList.add('loaded');
                                observer.unobserve(entry.target);
                            }
                        }
                    });
                }, options);
            }
            // ##################
            
            submitCurrentFrameBtn.addEventListener('click', () => {
                if (videoPreviewModal.style.display === 'flex' && currentVideoPreviewData) {
                    const currentTime = videoPlayer.currentTime;
                    const frameId = Math.round(currentTime * currentVideoPreviewData.fps);
                    console.log("--- [Video Player Submission] ---");
                    console.log(`Video ID: ${currentVideoPreviewData.videoId}`);
                    console.log(`Current Time: ${currentTime.toFixed(4)}s`);
                    console.log(`Video FPS: ${currentVideoPreviewData.fps}`);
                    console.log(`Calculated Frame ID: ${frameId}`);
                    console.log("---------------------------------");
                    const submissionData = {
                        video_id: currentVideoPreviewData.videoId,
                        frame_id: frameId,
                        filepath: `player_submission_at_${currentTime.toFixed(2)}s`
                    };
                    handleSubmitToDRES(submissionData, true);
                } else {
                    alert("No active video context to submit from. Please open a video preview first.");
                    console.error("Submit button clicked, but 'currentVideoPreviewData' is missing.");
                }
            });

            pushCurrentFrameBtn.addEventListener('click', () => {
                if (videoPreviewModal.style.display === 'flex' && currentVideoPreviewData) {
                    const currentTime = videoPlayer.currentTime;
                    const frameId = Math.round(currentTime * currentVideoPreviewData.fps);
                    const canvas = document.createElement('canvas');
                    canvas.width = videoPlayer.videoWidth;
                    canvas.height = videoPlayer.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
                    const thumbnailUrl = canvas.toDataURL('image/jpeg', 0.8);
                    const shotData = {
                        video_id: currentVideoPreviewData.videoId,
                        frame_id: frameId,
                        fps: currentVideoPreviewData.fps,
                        filepath: `dynamic-frame-${currentVideoPreviewData.videoId}-${frameId}`,
                        url: thumbnailUrl,
                        is_dynamic: true
                    };
                    console.log("--- [Video Player Push to Teamwork] ---");
                    console.log(`Video ID: ${shotData.video_id}`);
                    console.log(`Current Time: ${currentTime.toFixed(4)}s`);
                    console.log(`Video FPS: ${shotData.fps}`);
                    console.log(`Calculated Frame ID: ${shotData.frame_id}`);
                    console.log("Pushing shotData object:", shotData);
                    console.log("---------------------------------------");
                    pushToTeamworkPanel(shotData);
                } else {
                    alert("No active video context to push from. Please open a video preview first.");
                    console.error("Push button clicked, but 'currentVideoPreviewData' is missing.");
                }
            });

            rightResultsPanel.addEventListener('scroll', () => {
                if (rightResultsPanel.scrollTop + rightResultsPanel.clientHeight >= rightResultsPanel.scrollHeight - 500) {
                    loadMoreResults();
                }
            });

            async function handleGoogleImageAction(url, action, buttonEl) {
                if (!url || !action) return;
                const originalIcon = buttonEl.innerHTML;
                buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                buttonEl.disabled = true;

                try {
                    const downloadResponse = await fetch('/download_external_image', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url })
                    });
                    if (!downloadResponse.ok) {
                        const err = await downloadResponse.json();
                        throw new Error(err.detail || 'Failed to download image');
                    }
                    const imageData = await downloadResponse.json();
                    
                    if (action === 'search') {
                        addStageToStart();
                        const newStage = stagesContainer.querySelector('.stage-card');
                        if (newStage) {
                            newStage.querySelector('.type-btn[data-type="image"]')?.click();
                            const previewImage = newStage.querySelector('.image-preview');
                            const uploadInstructions = newStage.querySelector('.upload-instructions');
                            const removeImageBtn = newStage.querySelector('.remove-image-btn');
                            
                            newStage.tempImageName = imageData.temp_image_name;
                            previewImage.src = imageData.url;
                            previewImage.style.display = 'block';
                            uploadInstructions.style.display = 'none';
                            removeImageBtn.style.display = 'flex';
                            handleSearch();
                        }
                    } else if (action === 'push') {
                        const shotData = {
                            filepath: imageData.filepath,
                            url: imageData.url,
                            video_id: 'N/A',
                            shot_id: 'N/A',
                            frame_id: 'N/A'
                        };
                        pushToTeamworkPanel(shotData);
                    }

                } catch (error) {
                    console.error(`Google Image Action [${action}] failed:`, error);
                    alert(`Error: ${error.message}`);
                } finally {
                    buttonEl.innerHTML = originalIcon;
                    buttonEl.disabled = false;
                }
            }

            function displayGoogleImages(urls) {
                googleResultsContainer.innerHTML = '';
                if (urls.length === 0) {
                    googleResultsContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">No images found.</p>';
                    return;
                }
                urls.forEach(url => {
                    const item = document.createElement('div');
                    item.className = 'google-image-item';
                    item.innerHTML = `<img src="${url}" loading="lazy" onerror="this.parentElement.style.display='none'">`;
                    item.title = "Click: Zoom\nCtrl+Shift+Click: Similarity Search";

                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (e.ctrlKey && e.shiftKey) {
                            const fakeShotData = {
                                url: url,
                                filepath: `google-image-${Date.now()}.jpg`,
                                is_external: true
                            };
                            performImageSearchFromClick(fakeShotData);
                        } else {
                            handleGoogleImageAction(url, 'zoom', item);
                        }
                    });

                    item.addEventListener("mouseenter", () => {
                        currentlyHoveredItemData = { external_url: url };
                        currentlyHoveredItemElement = item;
                    });
                    item.addEventListener("mouseleave", () => {
                        currentlyHoveredItemData = null;
                        currentlyHoveredItemElement = null;
                    });

                    googleResultsContainer.appendChild(item);
                });
            }

            async function fetchGoogleImages() {
                const query = googleSearchInput.value.trim();
                if (!query) return;

                googleResultsWrapper.style.display = 'block';
                googleResultsContainer.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; margin: auto;"></i>';
                
                try {
                    const response = await fetch('/google_image_search', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ query })
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Search failed');
                    }
                    const data = await response.json();
                    displayGoogleImages(data.image_urls || []);
                } catch (error) {
                    googleResultsContainer.innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
                }
            }

            googleSearchBtn.addEventListener('click', fetchGoogleImages);
            googleSearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation(); 
                    fetchGoogleImages();
                }
            });
            
            function djb2(str) { let hash = 5381; for (let i = 0; i < str.length; i++) { hash = ((hash << 5) + hash) + str.charCodeAt(i); } return hash; }
            function generateColor(str) { const hash = djb2(str); const h = hash % 360; const s = ((hash >> 8) % 31) + 70; const l = ((hash >> 16) % 21) + 50; return `hsl(${h}, ${s}%, ${l}%)`; }
            function createResultItem(data, source = 'main') {
                const isTeamworkItem = source === 'teamwork';
                const shot = isTeamworkItem ? data.shot : data;
                const user = isTeamworkItem ? data.user : null;
                if (!shot || !shot.url) return null;

                const item = document.createElement('div');
                item.className = 'result-item';
                item.dataset.source = source;
                item.dataset.filepath = shot.filepath;             
                item.dataset.videoId = shot.video_id;
                item.dataset.shotId = shot.shot_id;
                item.dataset.frameId = shot.frame_id;
                
                const isLazy = source === 'main';
                const srcAttribute = isLazy ? `data-src="${shot.url}"` : `src="${shot.url}"`;
                const imgClass = isLazy ? 'lazy-load' : 'loaded';

                let title = '';
                let itemHTML = '';

                if (isTeamworkItem) {
                    item.classList.add('teamwork-item');
                    item.style.setProperty('--user-color', user.color);
                    title = `Pushed by: ${user.name}\n\nClick: Submit to DRES\nCtrl+Click: Submit directly`;
                    const dresButtonHTML = `<button class="submit-btn" title="Click: Submit with confirmation | Ctrl+Click: Submit Direct"><i class="fas fa-paper-plane"></i></button>`;
                    itemHTML = `<img class="loaded" src="${shot.url}" alt="Teamwork Frame" title="${title}">${dresButtonHTML}<div class="teamwork-item-user-label">${user.name}</div>`;
                } else {
                    title = `Click: Zoom\nCtrl+Shift+Click: Similarity Search\nRight-Click: Video Preview\nCtrl+Click: View Context`;
                    const score = shot.rrf_score || shot.cluster_score || shot.score || shot.average_rrf_score || shot.combined_score;
                    if (score) title += `\nScore: ${score.toFixed(4)}`;
                    const dresButtonHTML = `<button class="submit-btn" title="This button is for Teamwork Panel items. Use keyboard shortcuts for this item."></button>`;
                    itemHTML = `<img class="${imgClass}" ${srcAttribute} alt="Result Frame" title="${title}">${dresButtonHTML}`;
                }

                item.innerHTML = itemHTML;
                item.addEventListener("click", e => handleBaseItemClick(e, shot, source));
                item.addEventListener("contextmenu", e => handleBaseItemClick(e, shot, source));

                const submitBtn = item.querySelector(".submit-btn");
                if (submitBtn) {
                    submitBtn.addEventListener("click", e => handleFrameInteraction(e, shot, source));
                }

                item.addEventListener("mouseenter", () => { currentlyHoveredItemData = shot; currentlyHoveredItemElement = item; });
                item.addEventListener("mouseleave", () => { currentlyHoveredItemData = null; currentlyHoveredItemElement = null; });

                return item;
            }

            function initWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
                ws.onopen = () => { console.log('WebSocket connection established.'); teamworkPanelContainer.style.display = 'block'; };
                
                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'new_frame') {
                        const newItem = createResultItem(message.data, 'teamwork');
                        if (newItem) teamworkGrid.prepend(newItem);
                    } else if (message.type === 'remove_frame') {
                        const filepathToRemove = message.data.filepath;
                        if (filepathToRemove) {
                            const itemToRemove = teamworkGrid.querySelector(`.result-item[data-filepath="${filepathToRemove}"]`);
                            if (itemToRemove) {
                                console.log(`Removing frame ${filepathToRemove} requested by ${message.data.user.name}.`);
                                itemToRemove.remove();
                            }
                            pushedFrames.delete(filepathToRemove);
                        }
                    } else if (message.type === 'clear_panel') {
                        teamworkGrid.innerHTML = '';
                        pushedFrames.clear();
                        if (message.status === 'success' && lastSuccessfulSubmission) {
                            pushToTeamworkPanel(lastSuccessfulSubmission);
                            lastSuccessfulSubmission = null;
                        }
                    }
                };
                
                ws.onclose = () => { console.log('WebSocket connection closed. Retrying in 3 seconds...'); setTimeout(initWebSocket, 3000); };
                ws.onerror = (error) => { console.error('WebSocket error:', error); };
            }
            
            function setupUser() {
                username = sessionStorage.getItem('username');
                userColor = sessionStorage.getItem('userColor');
                if (!username) {
                    usernameModal.style.display = 'flex';
                    usernameInput.focus();
                } else {
                    usernameModal.style.display = 'none';
                    userInfoDisplay.textContent = `User: ${username}`;
                    userInfoDisplay.style.color = userColor;
                    initWebSocket();
                }
            }
            usernameSubmitBtn.addEventListener('click', () => { const name = usernameInput.value.trim(); if (name) { sessionStorage.setItem('username', name); sessionStorage.setItem('userColor', generateColor(name)); setupUser(); } });
            usernameInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') usernameSubmitBtn.click(); });
            function pushToTeamworkPanel(shotData) {
                if (!shotData || !shotData.filepath) { console.error("Attempted to push invalid shot data:", shotData); return; }
                if (pushedFrames.has(shotData.filepath)) { console.log("This frame has already been pushed."); return; }
                if (!ws || ws.readyState !== WebSocket.OPEN) { alert("Teamwork connection is not available."); return; }
                pushedFrames.add(shotData.filepath);
                const payload = { type: 'new_frame', data: { shot: shotData, user: { name: username, color: userColor } } };
                ws.send(JSON.stringify(payload));
                console.log("Pushed to teamwork panel:", shotData.filepath);
            }
            async function handleSubmitToDRES(shot, bypassConfirmation = false) {
                if (!dresSessionId || !dresEvaluationId) {
                    alert("Please log in to DRES and select an evaluation first.");
                    dresModal.style.display = 'flex';
                    return;
                }
                if (shot.video_id && shot.video_id !== 'N/A' && shot.filepath) {
                    lastSuccessfulSubmission = shot;
                    const confirmation = bypassConfirmation ? true : confirm(`Submit this result to DRES?\n\nVideo: ${shot.video_id}\nFilepath: ${shot.filepath}`);
                    if (!confirmation) {
                        lastSuccessfulSubmission = null;
                        return;
                    }
                    try {
                        const response = await fetch('/dres/submit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId: dresSessionId, evaluationId: dresEvaluationId, video_id: shot.video_id, filepath: shot.filepath, frame_id: shot.frame_id }) });
                        if (!response.ok) { const err = await response.json(); throw new Error(err.detail || 'Submission failed'); }
                        const result = await response.json();
                        alert(`Submission successful!\nStatus: ${result.submission}\nDescription: ${result.description}`);
                    } catch (error) {
                        alert(`Submission Error: ${error.message}`);
                        lastSuccessfulSubmission = null;
                    }
                } 
                else if (shot.external_url) {
                    alert("Direct DRES submission is not supported for external Google Images yet.");
                }
                else {
                    alert("Submission failed: Missing required data (video_id, filepath, or external_url).");
                }
            }

            async function handleGoogleImageAction(url, action, element) {
                if (!url || !action) return;

                if (action === 'zoom') {
                    imageModal.style.display = "flex";
                    zoomedImage.src = url;
                    return;
                }
                
                element.style.cursor = 'wait';
                try {
                    const downloadResponse = await fetch('/download_external_image', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url })
                    });
                    if (!downloadResponse.ok) {
                        const err = await downloadResponse.json();
                        throw new Error(err.detail || 'Failed to prepare image');
                    }
                    const imageData = await downloadResponse.json();
                    
                    const shotData = {
                        filepath: imageData.filepath,
                        url: imageData.url,
                        video_id: 'N/A',
                        shot_id: 'N/A',
                        frame_id: 'N/A',
                        external_url: url
                    };

                    if (action === 'search') {
                        addStageToStart();
                        const newStage = stagesContainer.querySelector('.stage-card');
                        if (newStage) {
                            newStage.querySelector('.type-btn[data-type="image"]')?.click();
                            const previewImage = newStage.querySelector('.image-preview');
                            const uploadInstructions = newStage.querySelector('.upload-instructions');
                            const removeImageBtn = newStage.querySelector('.remove-image-btn');
                            newStage.tempImageName = imageData.temp_image_name;
                            previewImage.src = imageData.url;
                            previewImage.style.display = 'block';
                            uploadInstructions.style.display = 'none';
                            removeImageBtn.style.display = 'flex';
                            handleSearch();
                        }
                    } else if (action === 'push') {
                        pushToTeamworkPanel(shotData);
                    } else if (action === 'submit') {
                        handleSubmitToDRES(shotData, true);
                    }

                } catch (error) {
                    console.error(`Google Image Action [${action}] failed:`, error);
                    alert(`Error: ${error.message}`);
                } finally {
                    element.style.cursor = 'pointer';
                }
            }
            function handleFrameInteraction(event, shotData, source) {
                event.preventDefault();
                event.stopPropagation();
                if (source === 'teamwork') {
                    const isCtrl = event.ctrlKey || event.metaKey;
                    handleSubmitToDRES(shotData, isCtrl);
                }
            }
            function handleBaseItemClick(event, shotData, source) {
                event.preventDefault();
                event.stopPropagation();
                
                if (event.ctrlKey && event.shiftKey) {
                    performImageSearchFromClick(shotData);
                } 
                else if (event.type === 'contextmenu') {
                    openVideoPreview(shotData); 
                } 
                else if (event.ctrlKey || event.metaKey) {
                    openTemporalContextView(shotData);
                }
                else {
                    imageModal.style.display = "flex";
                    zoomedImage.src = shotData.url;
                }
            }
            async function openVideoPreview(shotData) {
                if (!shotData || !shotData.video_id || !shotData.filepath) {
                    alert("Error: Invalid data for video preview (missing video_id or filepath).");
                    return;
                }

                const frameId = shotData.frame_id;
                if (frameId === null || frameId === undefined) {
                    alert(`Error: Frame ID is missing for this result.`);
                    return;
                }
                
                videoPreviewModal.style.display = "flex";
                videoPlayer.pause();
                videoPlayer.src = "";
                currentVideoPreviewData = null; // Reset context on open

                try {
                    console.log(`[Player] Opening preview for video: ${shotData.video_id}, frame: ${frameId}`);
                    
                    // Fetch video info (for FPS) from the server
                    const infoResponse = await fetch(`/video_info/${shotData.video_id}`);
                    if (!infoResponse.ok) {
                        throw new Error(`Could not fetch video info (status: ${infoResponse.status})`);
                    }
                    const videoInfo = await infoResponse.json();
                    const actualFps = videoInfo.fps;
                    
                    // Store the essential data for the submission shortcut
                    currentVideoPreviewData = {
                        videoId: shotData.video_id,
                        fps: actualFps
                    };
                    console.log(`[Player] Video context set: ID=${currentVideoPreviewData.videoId}, FPS=${currentVideoPreviewData.fps}`);

                    const startTime = frameId / actualFps;
                    const videoUrl = `/videos/${shotData.video_id}`;
                    
                    console.log(`[Player] Setting video source to: ${videoUrl} and seeking to ${startTime.toFixed(2)}s`);
                    videoPlayer.src = videoUrl;
                    
                    videoPlayer.addEventListener('loadedmetadata', () => {
                        console.log(`[Player] Video metadata loaded. Duration: ${videoPlayer.duration}s`);
                        if (isFinite(startTime) && startTime < videoPlayer.duration) {
                            videoPlayer.currentTime = startTime;
                        }
                    }, { once: true });

                    videoPlayer.load();

                } catch (error) {
                    console.error("Error setting up video preview:", error);
                    alert("Error loading video preview: " + error.message);
                    currentVideoPreviewData = null; // Clear context on error
                    // Fallback to original simple behavior if anything fails
                    const startTime = frameId / 30; // Fallback FPS
                    const videoUrl = `/videos/${shotData.video_id}`;
                    videoPlayer.src = videoUrl;
                    videoPlayer.currentTime = startTime > 0 ? startTime : 0;
                }
            }

            async function openTemporalContextView(e){
                if(!e||!e.filepath)return void alert("Error: Invalid data for context view.");
                if (e.is_dynamic) { alert("Temporal context view is not available for frames pushed directly from the video player."); return; }
                temporalModalTitle.textContent=`Loading context for Video: ${e.video_id}, Frame: ${e.frame_id}...`;
                temporalGrid.innerHTML='<p style="color: white; text-align: center; padding: 20px;">Checking available frames...</p>';
                temporalContextModal.style.display="flex";
                try{
                    const t=await fetch("/check_temporal_frames",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({base_filepath:e.filepath})});
                    if(!t.ok){const o=await t.json();throw new Error(o.detail||"Failed to check frames.")}
                    const o=await t.json();
                    if(0===o.length)return void(temporalGrid.innerHTML='<p style="color: #ffcccc; text-align: center;">No context frames found.</p>');
                    temporalModalTitle.textContent=`Frame Context – Video: ${e.video_id||"N/A"}, Frame: ${e.frame_id||"N/A"}`;
                    temporalGrid.innerHTML="";
                    const r=e.filepath.match(/_(\d+)\./),s=r?parseInt(r[1],10):null;
                    o.forEach(t=>{
                        const frame_id_match = t.match(/_(\d+)\.[^.]+$/);
                        const temporalShotItem = createResultItem({
                            url: `/images/${urlSafeB64Encode(t)}`,
                            filepath: t,
                            video_id: e.video_id,
                            shot_id: e.shot_id,
                            frame_id: frame_id_match ? parseInt(frame_id_match[1], 10) : null
                        }, 'context');
                        if(temporalShotItem) {
                            temporalShotItem.classList.add('temporal-grid-item');
                            const label = document.createElement('div');
                            label.className = 'temporal-item-label';
                            const a = t.match(/_(\d+)\./);
                            if (a && s !== null) {
                                const l = parseInt(a[1], 10) - s;
                                label.textContent = l > 0 ? `+${l}` : `${l}`;
                                if (l === 0) temporalShotItem.classList.add("center-frame");
                            }
                            temporalShotItem.prepend(label);
                            temporalGrid.appendChild(temporalShotItem);
                        }
                    })
                } catch(t) { console.error("Error loading context view:",t),temporalGrid.innerHTML=`<p style="color: #ffcccc; text-align: center;">Error: ${t.message}</p>` }
            }
            
            function displayResults(data, append = false) {
                const fragment = document.createDocumentFragment();

                if (!append) {
                    resultsContainer.innerHTML = "";
                    if (imageObserver) imageObserver.disconnect();
                    setupImageObserver();
                }

                const moreLoader = document.getElementById('moreLoader');
                if (moreLoader) moreLoader.remove();

                if (!Array.isArray(data) || data.length === 0) {
                    if (!append) resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Không tìm thấy kết quả.</p>';
                    return;
                }

                const isClusteredMode = clusterBtn.classList.contains("active");
                const createGridWithItems = (items) => {
                    const gridFragment = document.createDocumentFragment();
                    const grid = document.createElement('div');
                    grid.className = 'results-grid';
                    items.forEach(shot => {
                        const itemElement = createResultItem(shot, 'main');
                        if (itemElement) {
                            grid.appendChild(itemElement);
                            if (imageObserver) imageObserver.observe(itemElement);
                        }
                    });
                    gridFragment.appendChild(grid);
                    return gridFragment;
                };

                const isTemporalSearch = currentResponse.is_temporal_search;
                const isAmbiguousSearch = currentResponse.is_ambiguous_search;

                if (isTemporalSearch || isAmbiguousSearch) {
                    data.forEach((sequence, seqIndex) => {
                        const sequenceContainer = document.createElement('div');
                        const sequenceHeader = document.createElement("div");
                        sequenceHeader.className = "sequence-header";
                        const headerText = isAmbiguousSearch ? `Ambiguous Match in Video: ${sequence.video_id || "N/A"}` : `Sequence ${seqIndex + 1 + ((currentPage - 1) * PAGE_SIZE)} (Video: ${sequence.video_id || "N/A"})`;
                        sequenceHeader.innerHTML = `<i class="fas fa-stream"></i> ${headerText}`;
                        sequenceContainer.appendChild(sequenceHeader);

                        if (isClusteredMode) {
                            (sequence.clusters || []).forEach((cluster) => {
                                const stageContainer = document.createElement('div');
                                const sortedShots = [...(cluster.shots || [])].sort((a, b) => (a.shot_id_int || 0) - (b.shot_id_int || 0) || (a.frame_id || 0) - (b.frame_id || 0));
                                stageContainer.appendChild(createGridWithItems(sortedShots));
                                sequenceContainer.appendChild(stageContainer);
                            });
                        } else {
                            sequenceContainer.appendChild(createGridWithItems(sequence.shots || []));
                        }
                        fragment.appendChild(sequenceContainer);
                        if (seqIndex < data.length - 1) {
                            const separator = document.createElement('hr');
                            separator.className = 'cluster-separator';
                            fragment.appendChild(separator);
                        }
                    });
                } else { 
                    if (isClusteredMode) {
                        data.forEach((cluster, index) => {
                            const newClusterContainer = document.createElement('div');
                            if (cluster.shots && cluster.shots.length > 0) {
                                const clusterHeader = document.createElement('h3');
                                clusterHeader.className = 'cluster-header';
                                clusterHeader.textContent = `Cluster from Video: ${cluster.shots[0].video_id}`;
                                newClusterContainer.appendChild(clusterHeader);
                            }
                            const sortedShots = [...(cluster.shots || [])].sort((a, b) => (a.shot_id_int || 0) - (b.shot_id_int || 0) || (a.frame_id || 0) - (b.frame_id || 0));
                            newClusterContainer.appendChild(createGridWithItems(sortedShots));
                            fragment.appendChild(newClusterContainer);
                            if (index < data.length - 1) {
                                const separator = document.createElement('hr');
                                separator.className = 'cluster-separator';
                                fragment.appendChild(separator);
                            }
                        });
                    } else {
                        const allShots = data.flatMap(item => item.shots ? item.shots : (item.best_shot ? [item.best_shot] : (item.filepath ? [item] : [])));
                        allShots.sort((a, b) => (b.rrf_score || 0) - (a.rrf_score || 0));
                        const uniqueShots = Array.from(new Map(allShots.filter(Boolean).map(shot => [shot.filepath, shot])).values());
                        
                        if (append) {
                            const grid = resultsContainer.querySelector('.results-grid');
                            if(grid) {
                                uniqueShots.forEach(shot => {
                                    const itemElement = createResultItem(shot, 'main');
                                    if (itemElement) {
                                        grid.appendChild(itemElement);
                                        if (imageObserver) imageObserver.observe(itemElement);
                                    }
                                });
                            }
                        } else {
                            fragment.appendChild(createGridWithItems(uniqueShots));
                        }
                    }
                }
                resultsContainer.appendChild(fragment);
            }

        async function performImageSearchFromClick(shot) {
            if (!shot || !shot.url || !shot.filepath) {
                alert("Dữ liệu không hợp lệ để tìm kiếm bằng hình ảnh.");
                return;
            }
            if (temporalContextModal.style.display === "flex") { temporalContextModal.style.display = "none"; }
            if (imageModal.style.display === "flex") { imageModal.style.display = "none"; }

            loadingIndicator.style.display = 'block';
            resultsContainer.innerHTML = '';
            
            try {
                let imageBlob;
                
                if (shot.is_external) {
                    const downloadResponse = await fetch('/download_external_image', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url: shot.url })
                    });
                    if (!downloadResponse.ok) {
                        const err = await downloadResponse.json();
                        throw new Error(err.detail || 'Failed to prepare external image');
                    }
                    const imageData = await downloadResponse.json();
                    const localImageResponse = await fetch(imageData.url);
                    if (!localImageResponse.ok) {
                        throw new Error(`Không thể tải ảnh đã xử lý: ${localImageResponse.statusText}`);
                    }
                    imageBlob = await localImageResponse.blob();
                } else {
                    const response = await fetch(shot.url);
                    if (!response.ok) {
                        throw new Error(`Không thể tải ảnh: ${response.statusText}`);
                    }
                    imageBlob = await response.blob();
                }

                const filename = shot.filepath.split("/").pop() || "clicked-image.jpg";
                const imageFile = new File([imageBlob], filename, { type: imageBlob.type });
                await handleSearch(imageFile);

            } catch (error) {
                console.error("Lỗi khi tìm kiếm bằng ảnh từ click:", error);
                alert(`Đã xảy ra lỗi: ${error.message}`);
                loadingIndicator.style.display = 'none';
            }
        }
            function clearModelFocus() { modelDropdown.querySelectorAll('.model-dropdown-item').forEach(item => item.classList.remove('focused')); focusedModelIndex = -1; }
            function updateModelFocus() { const items = modelDropdown.querySelectorAll('.model-dropdown-item'); items.forEach((item, index) => { item.classList.toggle('focused', index === focusedModelIndex); }); }
            function focusOnStageInput(stageElement) { if (!stageElement) return; const input = stageElement.querySelector('.main-query-input'); if (input) { input.focus(); input.setSelectionRange(input.value.length, input.value.length); } }
            
            function createStageCard(number) {
                const stageCard = document.createElement('div');
                stageCard.className = 'stage-card';
                stageCard.dataset.stageNumber = number;
                const queryTypes = [{ id: 'text', icon: 'fas fa-font', label: 'Text (Ctrl+Alt+U)', type: 'primary' }, { id: 'image', icon: 'fas fa-image', label: 'Image (Ctrl+Alt+I)', type: 'primary' }, { id: 'ocr', icon: 'fas fa-text-height', label: 'OCR Filter (Ctrl+Alt+O)', type: 'filter' }, { id: 'asr', icon: 'fas fa-microphone', label: 'ASR Filter (Ctrl+Alt+P)', type: 'filter' }, { id: 'gen_image', icon: 'fas fa-lightbulb', label: 'Generate Image (Ctrl+Alt+G)', type: 'filter' }];
                let typesHTML = queryTypes.map(type => `<button class="type-btn ${type.id === 'text' ? 'active' : ''}" data-type="${type.id}" data-basetype="${type.type}" title="${type.label}"><i class="${type.icon}"></i></button>`).join('');
                
                stageCard.innerHTML = `
                    <div class="stage-number">${number}</div>
                    <button class="delete-stage" title="Delete Stage" style="display: ${stagesContainer.children.length > 0 ? 'flex' : 'none'}"><i class="fas fa-times"></i></button>
                    <div class="stage-header"><div class="query-types">${typesHTML}</div></div>
                    <div class="query-input-area">
                        <textarea class="stage-input main-query-input" placeholder="Nhập truy vấn tiếng Việt..." rows="3"></textarea>
                        <div class="processed-query-display-wrapper main-processed-query-wrapper">
                            <i class="fas fa-cogs" title="Processed Query"></i>
                            <span class="processed-query-display"></span>
                        </div>
                        <div class="generated-image-container" style="display: none; margin-top: 10px; border: 1px solid var(--border-color); border-radius: 12px; padding: 5px; background: var(--glass-bg); min-height: 50px; text-align: center;">
                            <img class="generated-image-preview" style="display: none; max-width: 100%; max-height: 150px; border-radius: 8px; object-fit: contain;">
                            <p class="gen-image-status" style="color: var(--text-secondary); padding: 10px;"></p>
                        </div>
                        <div class="image-search-container" style="display: none;">
                            <label for="file-input-${number}" class="image-upload-zone">
                                <div class="upload-instructions"><i class="fas fa-cloud-upload-alt"></i><p>Kéo & thả ảnh hoặc <strong>nhấn để chọn file</strong></p></div>
                                <img class="image-preview" style="display: none;">
                                <button class="remove-image-btn" style="display: none;" title="Xóa ảnh"><i class="fas fa-times"></i></button>
                            </label>
                            <input type="file" id="file-input-${number}" class="stage-input-file" accept="image/*">
                            <input type="text" class="stage-input image-search-text-input" placeholder="Thêm mô tả văn bản cho ảnh (tùy chọn)..." style="margin-top: 10px;">
                            <div class="processed-query-display-wrapper image-processed-query-wrapper">
                                <i class="fas fa-cogs" title="Processed Image Text"></i>
                                <span class="processed-query-display"></span>
                            </div>
                        </div>
                        <div class="filter-input-wrapper" data-filter-type="ocr" style="display: none; margin-top: 10px;">
                            <input type="text" class="stage-input ocr-filter-input" placeholder="Lọc theo từ khóa OCR...">
                        </div>
                        <div class="filter-input-wrapper" data-filter-type="asr" style="display: none; margin-top: 10px;">
                            <input type="text" class="stage-input asr-filter-input" placeholder="Lọc theo từ khóa ASR...">
                        </div>
                    </div>
                    <div class="stage-options">
                        <button class="option-btn" data-option="enhance" title="Enhance Query (Ctrl+Q)">Enhance</button>
                        <button class="option-btn" data-option="expand" title="Expand Query (Ctrl+E)">Expand</button>
                        <button class="option-btn" data-option="unite_fusion" title="Use Unite Fusion Search (Ctrl+U)">Fusion</button>
                    </div>`;

                const mainTextInput = stageCard.querySelector('.main-query-input');
                const imageSearchContainer = stageCard.querySelector('.image-search-container');
                const stageOptions = stageCard.querySelector('.stage-options');
                const imageUploadZone = stageCard.querySelector('.image-upload-zone');
                const mainProcessedWrapper = stageCard.querySelector('.main-processed-query-wrapper');
                
                stageCard.querySelectorAll('.type-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const type = button.dataset.type;
                        const baseType = button.dataset.basetype;

                        if (baseType === 'primary') {
                            stageCard.querySelectorAll('.type-btn[data-basetype="primary"]').forEach(btn => { if (btn !== button) btn.classList.remove('active'); });
                            button.classList.add('active');
                            
                            const isTextMode = type === 'text';
                            mainTextInput.style.display = isTextMode ? 'block' : 'none';
                            mainProcessedWrapper.style.display = isTextMode ? 'flex' : 'none';
                            imageSearchContainer.style.display = isTextMode ? 'none' : 'block';
                            stageOptions.style.display = isTextMode ? 'flex' : 'none';

                        } else {
                            button.classList.toggle('active');
                            const filterWrapper = stageCard.querySelector(`.filter-input-wrapper[data-filter-type="${type}"]`);
                            if (filterWrapper) {
                                filterWrapper.style.display = button.classList.contains('active') ? 'block' : 'none';
                                if (button.classList.contains('active')) { filterWrapper.querySelector('input').focus(); }
                            }
                        }
                        
                        const genImageBtn = stageCard.querySelector('.type-btn[data-type="gen_image"]');
                        if (genImageBtn && genImageBtn.classList.contains('active')) {
                            const textBtn = stageCard.querySelector('.type-btn[data-type="text"]');
                            if (!textBtn.classList.contains('active')) {
                                textBtn.click();
                            }
                        }
                    });
                });

                const handleFileSelect = async (file) => {
                    if (!file || !file.type.startsWith('image/')) return;
                    const previewImage = stageCard.querySelector('.image-preview');
                    const uploadInstructions = stageCard.querySelector('.upload-instructions');
                    const removeImageBtn = stageCard.querySelector('.remove-image-btn');
                    previewImage.src = URL.createObjectURL(file);
                    previewImage.style.display = 'block';
                    uploadInstructions.innerHTML = `<p>Uploading...</p>`;
                    uploadInstructions.style.display = 'block';
                    removeImageBtn.style.display = 'none';
                    const formData = new FormData();
                    formData.append('image', file);
                    try {
                        const response = await fetch('/upload_image', { method: 'POST', body: formData });
                        if (!response.ok) throw new Error(`Upload failed: ${response.statusText}`);
                        const data = await response.json();
                        stageCard.tempImageName = data.temp_image_name;
                        uploadInstructions.style.display = 'none';
                        removeImageBtn.style.display = 'flex';
                    } catch (error) {
                        console.error("Image upload error:", error);
                        alert("Lỗi upload ảnh. Vui lòng thử lại.");
                        previewImage.style.display = 'none';
                        uploadInstructions.innerHTML = `<i class="fas fa-cloud-upload-alt"></i><p>Kéo & thả ảnh hoặc <strong>nhấn để chọn file</strong></p>`;
                        uploadInstructions.style.display = 'block';
                        removeImageBtn.style.display = 'none';
                    }
                };
                
                stageCard.querySelector('.remove-image-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); stageCard.querySelector('.stage-input-file').value = ''; const previewImage = stageCard.querySelector('.image-preview'); const uploadInstructions = stageCard.querySelector('.upload-instructions'); const removeImageBtn = stageCard.querySelector('.remove-image-btn'); previewImage.src = ''; previewImage.style.display = 'none'; uploadInstructions.innerHTML = `<i class="fas fa-cloud-upload-alt"></i><p>Kéo & thả ảnh hoặc <strong>nhấn để chọn file</strong></p>`; uploadInstructions.style.display = 'block'; removeImageBtn.style.display = 'none'; delete stageCard.tempImageName; });
                stageCard.querySelector('.stage-input-file').addEventListener('change', e => handleFileSelect(e.target.files[0]));
                imageUploadZone.addEventListener('dragover', e => { e.preventDefault(); imageUploadZone.classList.add('dragover'); });
                imageUploadZone.addEventListener('dragleave', e => { e.preventDefault(); imageUploadZone.classList.remove('dragover'); });
                imageUploadZone.addEventListener('drop', e => { e.preventDefault(); imageUploadZone.classList.remove('dragover'); handleFileSelect(e.dataTransfer.files[0]); });
                stageCard.querySelector('.delete-stage')?.addEventListener('click', () => { stageCard.remove(); renumberStages(); });
                stageCard.querySelectorAll('.option-btn').forEach(button => { button.addEventListener('click', () => { button.classList.toggle('active'); }); });
                
                return stageCard;
            }

            async function handleSearch(imageFileFromClick = null) {
                const clientStartTime = performance.now();
                currentPage = 1;
                isLoadingMore = false;
                lastSearchPayload = null;

                loadingIndicator.style.display = 'block';
                resultsContainer.innerHTML = '';
                document.getElementById('timingInfoDisplay').style.display = 'none';
                currentResponse = {};
                pushedFrames.clear();

                const allStages = Array.from(stagesContainer.querySelectorAll('.stage-card'));

                allStages.forEach(stage => {
                    const displayWrapper = stage.querySelector('.main-processed-query-wrapper');
                    if (displayWrapper) {
                        displayWrapper.style.display = 'none';
                        displayWrapper.querySelector('.processed-query-display').textContent = '';
                    }
                });
                
                try {
                    const precomputationPromises = allStages.map(async (stage) => {
                        const genImageBtn = stage.querySelector('.type-btn[data-type="gen_image"]');
                        if (genImageBtn && genImageBtn.classList.contains('active')) {
                            const queryText = stage.querySelector('.main-query-input').value.trim();
                            const imageContainer = stage.querySelector('.generated-image-container');
                            const imagePreview = stage.querySelector('.generated-image-preview');
                            const imageStatus = stage.querySelector('.gen-image-status');
                            if (queryText) {
                                imageContainer.style.display = 'block';
                                imageStatus.textContent = 'Generating image...';
                                try {
                                    const response = await fetch('/generate_image_from_text', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: queryText, enhance: stage.querySelector('.option-btn[data-option="enhance"]').classList.contains('active'), expand: stage.querySelector('.option-btn[data-option="expand"]').classList.contains('active') }) });
                                    const data = await response.json();
                                    stage.generatedImageName = data.temp_image_name;
                                    imagePreview.src = data.image_url;
                                    imagePreview.style.display = 'block';
                                    imageStatus.textContent = '';
                                } catch (err) {
                                    imageStatus.textContent = `Error: ${err.message}`;
                                    imagePreview.style.display = 'none';
                                }
                            }
                        }
                    });

                    await Promise.all(precomputationPromises);
                
                    const objectFilters = getObjectFilterData();
                    let response;
                    let searchEndpoint;
                    let requestBody;

                    if (imageFileFromClick) {
                        searchEndpoint = '/search';
                        const searchData = { models: ["bge"], filters: objectFilters, image_search_text: "", page: 1, page_size: PAGE_SIZE };
                        lastSearchPayload = searchData;
                        const formData = new FormData();
                        formData.append('query_image', imageFileFromClick, imageFileFromClick.name);
                        formData.append('search_data', JSON.stringify(searchData));
                        requestBody = formData;
                    } else if (allStages.length === 1) {
                        searchEndpoint = '/search';
                        const firstStage = allStages[0];
                        const useUniteFusion = firstStage.querySelector('.option-btn[data-option="unite_fusion"]').classList.contains('active');
                        const searchData = { filters: objectFilters, page: 1, page_size: PAGE_SIZE, use_unite_fusion: useUniteFusion };
                        let hasPrimaryQuery = false;

                        if (firstStage.querySelector('.type-btn[data-type="gen_image"]')?.classList.contains('active')) {
                            const mainInput = firstStage.querySelector('.main-query-input');
                            searchData.query_text = mainInput.value.trim();
                            searchData.generated_image_name = firstStage.generatedImageName;
                            searchData.models = ["unite"];
                            if (searchData.query_text) hasPrimaryQuery = true;
                        } else if (firstStage.querySelector('.type-btn[data-type="image"].active')) {
                            const imageTextInput = firstStage.querySelector('.image-search-text-input');
                            if (firstStage.tempImageName) {
                                searchData.query_image_name = firstStage.tempImageName;
                                searchData.image_search_text = imageTextInput.value.trim();
                                searchData.models = ["bge"];
                                hasPrimaryQuery = true;
                            }
                        } else {
                            const mainInput = firstStage.querySelector('.main-query-input');
                            searchData.query_text = mainInput.value.trim();
                            searchData.models = Array.from(document.querySelectorAll('#modelDropdown input:checked')).map(cb => cb.value);
                            searchData.enhance = firstStage.querySelector('.option-btn[data-option="enhance"]').classList.contains('active');
                            searchData.expand = firstStage.querySelector('.option-btn[data-option="expand"]').classList.contains('active');
                            if (searchData.query_text) hasPrimaryQuery = true;
                        }

                        if (firstStage.querySelector('.type-btn[data-type="ocr"].active')) searchData.ocr_query = firstStage.querySelector('.ocr-filter-input').value.trim();
                        if (firstStage.querySelector('.type-btn[data-type="asr"].active')) searchData.asr_query = firstStage.querySelector('.asr-filter-input').value.trim();
                        if (!hasPrimaryQuery && !searchData.ocr_query && !searchData.asr_query) throw new Error("Please provide a main query or a filter.");
                        if (hasPrimaryQuery && searchData.models && searchData.models.length === 0) throw new Error("Please select at least one model.");
                        
                        lastSearchPayload = searchData;
                        const formData = new FormData();
                        formData.append('search_data', JSON.stringify(searchData));
                        requestBody = formData;
                    } else {
                        searchEndpoint = '/temporal_search';
                        const stagesData = allStages.map(stage => {
                            const mainInput = stage.querySelector('.main-query-input');
                            const stageDatum = {
                                query: mainInput.value.trim(),
                                query_image_name: stage.tempImageName || null,
                                generated_image_name: stage.generatedImageName || null,
                                enhance: stage.querySelector('.option-btn[data-option="enhance"]').classList.contains('active'),
                                expand: stage.querySelector('.option-btn[data-option="expand"]').classList.contains('active'),
                                use_unite_fusion: stage.querySelector('.option-btn[data-option="unite_fusion"]').classList.contains('active'),
                                ocr_query: stage.querySelector('.type-btn[data-type="ocr"].active') ? stage.querySelector('.ocr-filter-input').value.trim() : null,
                                asr_query: stage.querySelector('.type-btn[data-type="asr"].active') ? stage.querySelector('.asr-filter-input').value.trim() : null,
                            };
                            return stageDatum;
                        });
                        
                        const payload = { stages: stagesData, models: Array.from(document.querySelectorAll('#modelDropdown input:checked')).map(cb => cb.value), filters: objectFilters, ambiguous: ambiguousBtn.classList.contains('active'), page: 1, page_size: PAGE_SIZE };
                        lastSearchPayload = payload;
                        requestBody = JSON.stringify(payload);
                    }
                    
                    const fetchOptions = { method: 'POST' };
                    if (requestBody instanceof FormData) {
                        fetchOptions.body = requestBody;
                    } else {
                        fetchOptions.headers = { 'Content-Type': 'application/json' };
                        fetchOptions.body = requestBody;
                    }
                    
                    response = await fetch(searchEndpoint, fetchOptions);
                    if (!response.ok) { const err = await response.json(); throw new Error(err.detail || 'Unknown error from server.'); }
                    currentResponse = await response.json();

                    if (currentResponse.processed_query) {
                        const firstStage = allStages[0];
                        if (firstStage) {
                            const displayWrapper = firstStage.querySelector('.main-processed-query-wrapper');
                            const displaySpan = displayWrapper.querySelector('.processed-query-display');
                            displaySpan.textContent = currentResponse.processed_query;
                            displayWrapper.style.display = 'flex';
                        }
                    }
                    if (currentResponse.processed_queries && Array.isArray(currentResponse.processed_queries)) {
                        allStages.forEach((stage, index) => {
                            const processedQueryText = currentResponse.processed_queries[index];
                            if (processedQueryText) {
                                const displayWrapper = stage.querySelector('.main-processed-query-wrapper');
                                if (displayWrapper) {
                                    const displaySpan = displayWrapper.querySelector('.processed-query-display');
                                    displaySpan.textContent = processedQueryText;
                                    displayWrapper.style.display = 'flex';
                                }
                            }
                        });
                    }

                    totalResults = currentResponse.total_results || 0;
                    displayTimingInfo(currentResponse.timing_info, clientStartTime);
                    displayResults(currentResponse.results, false);

                } catch (error) {
                    console.error("[ERROR] Search failed:", error);
                    resultsContainer.innerHTML = `<p style="color: #ef4444; font-size: 1.1rem; text-align: center;"><strong>Error:</strong> ${error.message}</p>`;
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            }
            
            async function loadMoreResults() {
                const resultsCount = resultsContainer.querySelectorAll('.result-item, .sequence-result-container').length;
                if (isLoadingMore || !lastSearchPayload || (totalResults > 0 && resultsCount >= totalResults)) {
                    return;
                }
                isLoadingMore = true;
                currentPage++;

                const loader = document.createElement('div');
                loader.id = 'moreLoader';
                loader.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading more...';
                loader.style.textAlign = 'center';
                loader.style.padding = '20px';
                loader.style.fontSize = '1.2rem';
                resultsContainer.appendChild(loader);

                try {
                    let response;
                    let searchEndpoint;
                    let requestBody;
                    lastSearchPayload.page = currentPage;

                    if (lastSearchPayload.stages) { // Temporal search
                        searchEndpoint = '/temporal_search';
                        requestBody = JSON.stringify(lastSearchPayload);
                    } else { // Single stage search
                        searchEndpoint = '/search';
                        const formData = new FormData();
                        formData.append('search_data', JSON.stringify(lastSearchPayload));
                        requestBody = formData;
                    }
                    
                    const fetchOptions = { method: 'POST' };
                    if (requestBody instanceof FormData) {
                        fetchOptions.body = requestBody;
                    } else {
                        fetchOptions.headers = { 'Content-Type': 'application/json' };
                        fetchOptions.body = requestBody;
                    }

                    response = await fetch(searchEndpoint, fetchOptions);
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Failed to load more results.');
                    }
                    const data = await response.json();
                    displayResults(data.results, true);

                } catch (error) {
                    console.error("Error loading more results:", error);
                    loader.textContent = `Error: ${error.message}`;
                } finally {
                    isLoadingMore = false;
                    const existingLoader = document.getElementById('moreLoader');
                    if (existingLoader) {
                        existingLoader.remove();
                    }
                }
            }
            
            function getObjectFilterData(){const e={};if(enableCountFilter.checked){const t={};countFilterControls.querySelectorAll(".count-filter-row").forEach(e=>{const o=e.querySelector(".count-checkbox");if(o.checked){const r=e.querySelector(".condition-input").value.trim();if(r){let s=e.classList.contains("custom")?e.querySelector(".custom-object-name").value.trim().toLowerCase():o.dataset.object;s&&(t[s]=r)}}}),Object.keys(t).length>0&&(e.counting={conditions:t})}if(enablePositionFilter.checked&&drawnBoxes.length>0){const o=drawnBoxes.filter(e=>e.label).map(e=>({label:e.label,box:[e.x/posCanvas.width,e.y/posCanvas.height,(e.x+e.w)/posCanvas.width,(e.y+e.h)/posCanvas.height]}));o.length>0&&(e.positioning={boxes:o})}return objectFilterBtn.classList.toggle("active",enableCountFilter.checked||enablePositionFilter.checked),(enableCountFilter.checked||enablePositionFilter.checked)&&Object.keys(e).length>0?e:null}

            function createCountRow(e = "", t = !1) { const o = document.createElement("div"); o.className = "count-filter-row" + (t ? " custom" : ""); const r = `<input type="checkbox" class="count-checkbox" data-object="${e || "custom"}">`, s = t ? `<input type="text" class="filter-input custom-object-name" placeholder="object name">` : `<label>${e}</label>`, n = `<input type="text" class="filter-input condition-input" placeholder="e.g., >=1">`, i = t ? `<button class="remove-custom-btn">&times;</button>` : ""; o.innerHTML = `${r}${s}${n}${i}`; const a = o.querySelector(".count-checkbox"); const l = () => o.classList.toggle("active-row", a.checked); o.addEventListener("click", e => { e.target.tagName !== "INPUT" && e.target.tagName !== "BUTTON" && (a.checked = !a.checked, l()) }); a.addEventListener("change", l); const conditionInput = o.querySelector('.condition-input'); conditionInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') { event.preventDefault(); if (conditionInput.value.trim() !== '') { a.checked = true; l(); } conditionInput.blur(); } }); t && o.querySelector(".remove-custom-btn").addEventListener("click", () => o.remove()); l(); return o; }
            PREDEFINED_OBJECTS.forEach(e=>countFilterControls.appendChild(createCountRow(e))),addCustomCountBtn.addEventListener("click",()=>countFilterControls.appendChild(createCountRow("",!0)));
            function redrawCanvas(){if(!posCtx)return;posCtx.clearRect(0,0,posCanvas.width,posCanvas.height),posCtx.strokeStyle="#FFD700",posCtx.lineWidth=2,drawnBoxes.forEach((e,t)=>{posCtx.strokeRect(e.x,e.y,e.w,e.h),posCtx.font="14px 'Poppins'",posCtx.fillStyle="#FFD700",posCtx.fillText(`${t+1}: ${e.label||"no label"}`,e.x+5,e.y+16)}),isDrawing&&(posCtx.strokeStyle="var(--accent-pink)",posCtx.strokeRect(startX,startY,currentX-startX,currentY-startY))}
            function updateDrawnBoxesList(){drawnBoxesList.innerHTML="",drawnBoxes.forEach((e,t)=>{const o=document.createElement("div");o.className="drawn-box-item",o.textContent=`Box ${t+1}: ${e.label||"(unlabeled)"}`,drawnBoxesList.appendChild(o)})}posCanvas.addEventListener("pointerdown",e=>{isDrawing=!0,startX=e.offsetX,startY=e.offsetY}),posCanvas.addEventListener("pointermove",e=>{isDrawing&&(currentX=e.offsetX,currentY=e.offsetY,redrawCanvas())}),posCanvas.addEventListener("pointerup",e=>{if(!isDrawing)return;isDrawing=!1;const t=e.offsetX,o=e.offsetY,r={x:Math.min(startX,t),y:Math.min(startY,o),w:Math.abs(t-startX),h:Math.abs(o-startY),label:""};r.w>5&&r.h>5&&drawnBoxes.push(r),redrawCanvas(),updateDrawnBoxesList()});

            function renumberStages() {
                stagesContainer.querySelectorAll('.stage-card').forEach((card, index) => {
                    const stageNumberEl = card.querySelector('.stage-number');
                    if (stageNumberEl) stageNumberEl.textContent = index + 1;
                    const deleteBtn = card.querySelector('.delete-stage');
                    if (deleteBtn) {
                        deleteBtn.style.display = stagesContainer.children.length > 1 ? 'flex' : 'none';
                    }
                });
            }
            function addStageToEnd() {
                const newStage = createStageCard(0);
                stagesContainer.appendChild(newStage);
                renumberStages();
                focusOnStageInput(newStage);
            }
            function addStageToStart() {
                const newStage = createStageCard(0);
                stagesContainer.insertAdjacentElement('afterbegin', newStage);
                renumberStages();
                focusOnStageInput(newStage);
            }
            function removeStageFromEnd() {
                if (stagesContainer.children.length > 1) {
                    stagesContainer.lastChild.remove();
                    renumberStages();
                    focusOnStageInput(stagesContainer.lastChild);
                }
            }
            function removeStageFromStart() {
                if (stagesContainer.children.length > 1) {
                    stagesContainer.firstChild.remove();
                    renumberStages();
                    focusOnStageInput(stagesContainer.firstChild);
                }
            }
            
            setupImageObserver();
            setupUser();
            const initialStage = createStageCard(1);
            stagesContainer.appendChild(initialStage);
            focusOnStageInput(initialStage);

            addStageBtn.addEventListener('click', addStageToEnd);
            removeStageBtn.addEventListener('click', removeStageFromEnd);
            searchBtn.addEventListener('click', () => handleSearch(null));
            document.getElementById('resetBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to reset the search panel?')) {
                    stagesContainer.innerHTML = '';
                    addStageToStart();
                    currentResponse = {};
                    resultsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding-top: 100px; font-size: 1.5rem;">Sử dụng bảng điều khiển bên trái để bắt đầu tìm kiếm.</p>';
                    document.getElementById('timingInfoDisplay').style.display = 'none';
                    teamworkGrid.innerHTML = '';
                    pushedFrames.clear();
                    googleSearchInput.value = '';
                    googleResultsContainer.innerHTML = '';
                    googleResultsWrapper.style.display = 'none';
                }
            });            
            clusterBtn.addEventListener('click', () => {
                clusterBtn.classList.toggle('active');
                if (currentResponse.results && !isLoadingMore) {
                    currentPage = 1; 
                    const allData = currentResponse.results;
                    displayResults(allData, false);
                }
            });
            ambiguousBtn.addEventListener('click', () => { ambiguousBtn.classList.toggle('active'); });
            modelSelectBtn.addEventListener('click', (event) => { event.stopPropagation(); const isOpening = modelDropdown.style.display !== 'block'; modelDropdown.style.display = isOpening ? 'block' : 'none'; if (isOpening) { focusedModelIndex = 0; updateModelFocus(); } else { clearModelFocus(); } });
            window.addEventListener('click', (e) => { if (!modelDropdown.contains(e.target) && !modelSelectBtn.contains(e.target)) { if (modelDropdown.style.display === 'block') { modelDropdown.style.display = 'none'; clearModelFocus(); } } });
            closeImageModalBtn.addEventListener('click', () => { imageModal.style.display = "none"; });
            imageModal.addEventListener('click', (e) => { if (e.target === imageModal) { imageModal.style.display = "none"; } });
            closeTemporalModalBtn.addEventListener('click', () => { temporalContextModal.style.display = "none"; });
            temporalContextModal.addEventListener('click', (e) => { if (e.target === temporalContextModal) { temporalContextModal.style.display = "none"; } });
            
            function closeVideoModal() {
                videoPreviewModal.style.display = "none";
                videoPlayer.pause();
                videoPlayer.src = "";
                currentVideoPreviewData = null;
            }

            closeVideoModalBtn.addEventListener('click', closeVideoModal);
            videoPreviewModal.addEventListener('click', (e) => { 
                if (e.target === videoPreviewModal) { 
                    closeVideoModal(); 
                } 
            });
            modalCloseBtn.addEventListener('click', () => objectFilterModal.style.display = 'none');
            
            // ## START: DRES MODAL LOGIC WITH NEW FLOW ##
            dresModalCloseBtn.addEventListener('click', () => dresModal.style.display = 'none');

            // Handle showing the modal from the toolbar
            dresBtn.addEventListener('click', () => {
                if (dresSessionId) {
                    // If already logged in, show evaluation selection directly
                    dresInitialView.style.display = 'none';
                    dresLoginView.style.display = 'none';
                    dresEvaluationView.style.display = 'block';
                    
                    const selectedOption = dresEvaluationSelect.options[dresEvaluationSelect.selectedIndex];
                    dresStatus.textContent = selectedOption ? `Ready to submit to: ${selectedOption.text}` : 'Logged in, please select an evaluation.';
                    dresStatus.style.color = 'var(--accent-blue)';
                } else {
                    // If not logged in, show the initial login button
                    dresInitialView.style.display = 'block';
                    dresLoginView.style.display = 'none';
                    dresEvaluationView.style.display = 'none';
                    dresStatus.textContent = 'Status: Not logged in.';
                    dresStatus.style.color = 'var(--text-secondary)';
                }
                dresModal.style.display = 'flex';
            });

            // Handle clicking the "Login to DRES" button inside the modal
            dresShowLoginBtn.addEventListener('click', () => {
                dresInitialView.style.display = 'none';
                dresLoginView.style.display = 'flex';
                dresUsername.focus();
            });

            // Handle the actual login attempt
            dresLoginBtn.addEventListener('click', async () => {
                const user = dresUsername.value;
                const pass = dresPassword.value;
                if (!user || !pass) {
                    alert('Please enter username and password.');
                    return;
                }
                dresStatus.textContent = 'Logging in...';
                dresStatus.style.color = 'var(--text-secondary)';
                try {
                    const response = await fetch('/dres/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: user, password: pass })
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Login failed');
                    }
                    const data = await response.json();
                    dresSessionId = data.sessionId;
                    sessionStorage.setItem('dresSessionId', dresSessionId);
                    
                    const evalResponse = await fetch(`/dres/list_evaluations?session=${dresSessionId}`);
                    if (!evalResponse.ok) throw new Error('Failed to fetch evaluations');
                    const evaluations = await evalResponse.json();
                    
                    dresEvaluationSelect.innerHTML = '';
                    dresEvaluationSelect.disabled = false;
                    evaluations.forEach(ev => {
                        if (ev.status === 'ACTIVE') {
                            const option = document.createElement('option');
                            option.value = ev.id;
                            option.textContent = ev.name;
                            dresEvaluationSelect.appendChild(option);
                        }
                    });

                    if (dresEvaluationSelect.options.length > 0) {
                        dresEvaluationId = dresEvaluationSelect.value;
                        sessionStorage.setItem('dresEvaluationId', dresEvaluationId);
                    }
                    
                    alert('Login successful!');
                    dresModal.style.display = 'none'; // <-- EXIT afrer successful login

                } catch (error) {
                    dresStatus.textContent = `Error: ${error.message}`;
                    dresStatus.style.color = '#ef4444';
                    dresSessionId = null;
                    sessionStorage.removeItem('dresSessionId');
                }
            });

            dresEvaluationSelect.addEventListener('change', () => {
                dresEvaluationId = dresEvaluationSelect.value;
                sessionStorage.setItem('dresEvaluationId', dresEvaluationId);
                dresStatus.textContent = `Ready to submit to: ${dresEvaluationSelect.options[dresEvaluationSelect.selectedIndex].text}`;
            });
            // ## END: DRES MODAL LOGIC ##
            
            objectFilterBtn.addEventListener('click', () => {
                objectFilterModal.style.display = 'flex';
            });
            

            window.addEventListener('keydown', (event) => {
                const activeElement = document.activeElement;
                const isTyping = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA');

                if (videoPreviewModal.style.display === 'flex' && event.code === 'Space' && (event.ctrlKey || event.metaKey)) {
                    event.preventDefault();
                    if (event.shiftKey) {
                        submitCurrentFrameBtn.click();
                    } else {
                        pushCurrentFrameBtn.click();
                    }
                    return;
                }

                if (event.key === 'Escape') {
                    event.preventDefault();
                    if (isTyping) { activeElement.blur(); return; }
                    if (videoPreviewModal.style.display === 'flex') { closeVideoModal(); return; }
                    if (imageModal.style.display === 'flex') { imageModal.style.display = 'none'; return; }
                    if (temporalContextModal.style.display === 'flex') { temporalContextModal.style.display = 'none'; return; }
                    if (objectFilterModal.style.display === 'flex') { objectFilterModal.style.display = 'none'; return; }
                    if (dresModal.style.display === 'flex') { dresModal.style.display = 'none'; return; }
                    if (modelDropdown.style.display === 'block') { modelDropdown.style.display = 'none'; clearModelFocus(); return; }
                }
                
                const isModalVisible = Array.from(document.querySelectorAll('.modal-overlay')).some(m => m.style.display === 'flex' || m.style.display === 'block');
                
                if ((event.ctrlKey || event.metaKey)) {
                    if (event.key.toLowerCase() === 'f' && !event.shiftKey && !event.altKey) {
                        event.preventDefault();
                        if (objectFilterModal.style.display === 'flex') {
                            objectFilterModal.style.display = 'none';
                        } else {
                            objectFilterModal.style.display = 'flex';
                        }
                        return;
                    }
                    if (event.key.toLowerCase() === 'f' && event.shiftKey && !event.altKey) {
                        event.preventDefault();
                        document.getElementById('enableCountFilter').click();
                        document.getElementById('enablePositionFilter').click();
                        objectFilterBtn.classList.toggle('active', document.getElementById('enableCountFilter').checked || document.getElementById('enablePositionFilter').checked);
                        return;
                    }
                    if (event.key.toLowerCase() === 'm' && !event.shiftKey && !event.altKey) {
                        event.preventDefault();
                        modelSelectBtn.click();
                        return;
                    }
                }

                if (event.code === 'Space' && (event.ctrlKey || event.metaKey)) {
                    if (!isModalVisible && currentlyHoveredItemData && currentlyHoveredItemElement) {
                        event.preventDefault();
                        const itemData = currentlyHoveredItemData;
                        const itemElement = currentlyHoveredItemElement;
                        const source = itemElement.dataset.source;

                        if (event.shiftKey) {
                            console.log(`Direct Submit action on item from source: ${source}`);
                            if (itemData.external_url) {
                                handleGoogleImageAction(itemData.external_url, 'submit', itemElement);
                            } else {
                                handleSubmitToDRES(itemData, true);
                            }
                        } else {
                            if (source === 'teamwork') {
                                if (!ws || ws.readyState !== WebSocket.OPEN) { alert("Teamwork connection is not available."); return; }
                                console.log(`Requesting to remove frame: ${itemData.filepath}`);
                                ws.send(JSON.stringify({ type: 'remove_frame', data: { filepath: itemData.filepath, user: { name: username } } }));
                            } else {
                                console.log(`Push action on item from source: ${source}`);
                                if (itemData.external_url) {
                                    handleGoogleImageAction(itemData.external_url, 'push', itemElement);
                                } else {
                                    pushToTeamworkPanel(itemData);
                                }
                            }
                        }
                        return;
                    }
                }

                if (modelDropdown.style.display === 'block') {
                    event.preventDefault();
                    const items = modelDropdown.querySelectorAll('.model-dropdown-item');
                    if (items.length > 0) {
                        switch (event.key) {
                            case 'ArrowDown': focusedModelIndex = (focusedModelIndex + 1) % items.length; updateModelFocus(); break;
                            case 'ArrowUp': focusedModelIndex = (focusedModelIndex - 1 + items.length) % items.length; updateModelFocus(); break;
                            case 'Enter': case ' ': if (focusedModelIndex > -1) { items[focusedModelIndex].querySelector('input[type="checkbox"]')?.click(); } break;
                        }
                    }
                    return;
                }

                if (event.key === 'Enter') {
                    if (isTyping && event.shiftKey) { return; }
                    // Check which view is visible inside the DRES modal to trigger the correct button
                    if (dresModal.style.display === 'flex') {
                        event.preventDefault();
                        if (dresLoginView.style.display === 'flex') {
                            dresLoginBtn.click();
                        } else if (dresInitialView.style.display === 'block') {
                            dresShowLoginBtn.click();
                        }
                        return;
                    }
                    if (usernameModal.style.display === 'flex') { event.preventDefault(); usernameSubmitBtn.click(); return; }
                    event.preventDefault();
                    searchBtn.click();
                    return;
                }
                
                if (isModalVisible) {
                    const isObjectFilterModalVisible = objectFilterModal.style.display === 'flex';
                    if (isObjectFilterModalVisible && !isTyping) {
                        if (event.key in LABEL_SHORTCUTS && drawnBoxes.length > 0) { event.preventDefault(); drawnBoxes[drawnBoxes.length - 1].label = LABEL_SHORTCUTS[event.key]; }
                        else if (event.key === '7' && drawnBoxes.length > 0) { event.preventDefault(); const customLabel = prompt("Enter custom object label:", "person"); if (customLabel) drawnBoxes[drawnBoxes.length - 1].label = customLabel.toLowerCase(); }
                        else if (event.key === 'Backspace' && drawnBoxes.length > 0) { event.preventDefault(); drawnBoxes.pop(); }
                        else if (event.key.toLowerCase() === 'c') { event.preventDefault(); if (confirm("Clear all drawn boxes?")) drawnBoxes = []; }
                        redrawCanvas(); updateDrawnBoxesList();
                    }
                    return;
                }

                const stageToModify = isTyping ? activeElement.closest('.stage-card') : stagesContainer.querySelector('.stage-card:last-child');

                if ((event.ctrlKey || event.metaKey) && event.altKey && !event.shiftKey) {
                    let handled = true;
                    if (stageToModify) {
                        switch(event.key.toLowerCase()) {
                            case 'u': stageToModify.querySelector('.type-btn[data-type="text"]')?.click(); break;
                            case 'i': stageToModify.querySelector('.type-btn[data-type="image"]')?.click(); break;
                            case 'o': stageToModify.querySelector('.type-btn[data-type="ocr"]')?.click(); break;
                            case 'p': stageToModify.querySelector('.type-btn[data-type="asr"]')?.click(); break;
                            case 'g': stageToModify.querySelector('.type-btn[data-type="gen_image"]')?.click(); break;
                            default: handled = false;
                        }
                    } else { handled = false; }
                    if(handled) { event.preventDefault(); return; }
                }
                else if ((event.ctrlKey || event.metaKey) && event.shiftKey) {
                    let handled = true;
                    switch (event.code) {
                        case 'KeyR': document.getElementById('resetBtn')?.click(); break;
                        case 'KeyG': ambiguousBtn.click(); break;
                        case 'BracketRight': removeStageFromEnd(); break;
                        case 'BracketLeft': removeStageFromStart(); break;
                        default: handled = false;
                    }
                    if (handled) event.preventDefault();
                }
                else if ((event.ctrlKey || event.metaKey) && !event.altKey) {
                    const targetStageNum = parseInt(event.key);
                    if (!isNaN(targetStageNum) && targetStageNum >= 1 && targetStageNum <= 9) {
                        event.preventDefault();
                        const allStages = stagesContainer.querySelectorAll('.stage-card');
                        if (targetStageNum <= allStages.length) focusOnStageInput(allStages[targetStageNum - 1]);
                        return;
                    }

                    let handled = true;
                    switch (event.code) {
                        case 'BracketRight': addStageToEnd(); break;
                        case 'BracketLeft': addStageToStart(); break;
                        default:
                            switch (event.key.toLowerCase()) {
                                case 'g': clusterBtn.click(); break;
                                case 'q': stageToModify?.querySelector('.option-btn[data-option="enhance"]')?.click(); break;
                                case 'e': stageToModify?.querySelector('.option-btn[data-option="expand"]')?.click(); break;
                                case 'u': stageToModify?.querySelector('.option-btn[data-option="unite_fusion"]')?.click(); break;
                                default: handled = false;
                            }
                    }
                    if (handled) event.preventDefault();
                }
                else if (isTyping && ['ArrowUp', 'ArrowDown'].includes(event.key)) {
                    const allStages = Array.from(stagesContainer.querySelectorAll('.stage-card'));
                    if (allStages.length > 1) {
                        const currentStage = activeElement.closest('.stage-card');
                        let currentIndex = currentStage ? allStages.indexOf(currentStage) : -1;
                        if (currentIndex !== -1) {
                            event.preventDefault();
                            if (event.key === 'ArrowUp') { currentIndex = (currentIndex - 1 + allStages.length) % allStages.length; }
                            else if (event.key === 'ArrowDown') { currentIndex = (currentIndex + 1) % allStages.length; }
                            focusOnStageInput(allStages[currentIndex]);
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>